'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

exports.default = function (storeCreatorFn) {
	let renderFn = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : () => '';

	const actions = [];

	return (() => {
		var _ref = (0, _asyncToGenerator3.default)(function* (req, res, next) {
			try {
				// a fresh store is created each time
				const store = yield storeCreatorFn(req, res);

				res.getStore = function () {
					return store;
				};
				res.dispatch = function (action) {
					actions.push(action);
					store.dispatch(action);
				};
				res.getActions = function () {
					return [].concat(actions);
				};
				res.reduxRender = (0, _asyncToGenerator3.default)(function* () {
					if (req.xhr) {
						// if it is an XMLHttpRequest then we
						// return a JSON containing all the actions
						res.json(actions);
					} else {
						const html = yield renderFn(store, req, res);
						res.status(200).send(html);
					}
				});

				return next();
			} catch (err) {
				return next(err);
			}
		});

		return function (_x2, _x3, _x4) {
			return _ref.apply(this, arguments);
		};
	})();
};

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }